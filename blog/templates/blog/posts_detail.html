{% extends 'blog/base.html' %}
{% load static %}
{% block content %}

<article class="media content-section mb-4">

  <!-- Author profile pic with fallback -->
  <img class="rounded-circle article-img" 
       src="{% if object.author.profile.image %}{{ object.author.profile.image.url }}{% else %}/media/parents_default_image.jpg{% endif %}" 
       alt="Author Image">

  <div class="media-body">
    <div class="article-metadata mb-2">
      <a href="{% url 'user-posts' object.author.username %}">{{ object.author }}</a>
      <small class="text-muted">{{ object.date_posted|date:"F d, Y" }}</small>

      {% if object.author == user %}
      <div class="mt-1">
        <a class="btn btn-secondary btn-sm" href="{% url 'post-update' object.id %}">Update Post</a>
        <a class="btn btn-danger btn-sm" href="{% url 'post-delete' object.id %}">Delete Post</a>
      </div>
      {% endif %}
    </div>

    <h2 class="article-title">{{ object.title }}</h2>
    <p class="article-content">{{ object.content|linebreaks }}</p>

    {% if object.image %}
      <img class="img-fluid mt-2" src="{{ object.image.url }}" alt="{{ object.title }}">
    {% endif %}
  </div>
</article>

<hr>

<h4>Comments ({{ comments.count }})</h4>

{% for message in messages %}
  <div class="alert alert-info">{{ message }}</div>
{% endfor %}

{% for comment in comments %}
<div class="card mb-3">
  <div class="card-body d-flex align-items-start">
    <!-- Comment user profile pic with fallback -->
    <img src="{% if comment.user.profile.image %}{{ comment.user.profile.image.url }}{% else %}/media/parents_default_image.jpg{% endif %}" 
         alt="Profile" class="rounded-circle me-2" style="width:40px; height:40px; object-fit:cover;">

    <div class="flex-grow-1">
      <strong>{{ comment.user.username }}</strong>
      <small class="text-muted">â€¢ {{ comment.created_at|date:"M d, Y h:i A" }}</small>
      <p class="mb-1">{{ comment.body|linebreaks }}</p>

      {% if user == comment.user or user.is_superuser %}
      <form action="{% url 'delete_comment' comment.pk %}" method="POST" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
      </form>
      {% endif %}
    </div>
  </div>
</div>
{% empty %}
<p>No comments yet.</p>
{% endfor %}

{% if user.is_authenticated %}
<form method="POST" class="mt-3" action="{% url 'add_comment' object.pk %}">
  {% csrf_token %}
  {{ form.body }}
  <button type="submit" class="btn btn-primary mt-2">Post Comment</button>
</form>
{% else %}
<p><a href="{% url 'login' %}">Login</a> to comment.</p>
{% endif %}

{% endblock %}
